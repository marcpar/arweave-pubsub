# Near Processor

Service responsible for minting the nft

## Environment Configuration
| Key | Description |
| :-- | :---------- |
| `AZURE_ACCOUNT_NAME` | **REQUIRED**. azure account name |
| `AZURE_ACCOUNT_KEY` | **REQUIRED**. azure secret key |
| `TOPIC` | **REQUIRED**. name of the topic |
| `NEAR_ACCOUNT_NAME` | **REQUIRED**. near account that will sign the transactions |
| `NEAR_ACCOUNT_PRIVATE_KEY` | **REQUIRED**. NEAR_ACCOUNT_NAME private key |
| `NEAR_ACCOUNT_CONTRACT_NAME` | name of the minter contract, defaults to `NEAR_ACCOUNT_NAME` if not provided |
| `NEAR_DEPOSIT` | **REQUIRED***. amount of near to deposit in each transaction call, excess tokens are refunded automatically |
| `DEFAULT_CALLBACK_URL` | **REQUIRED**. default callback url that will receive the emitted events |
| `MAX_JOBS` | maximum number of jobs to be processed at the same time, setting to 0 will have no limit |
| `LOG_LEVEL` | [winston log level](https://www.npmjs.com/package/winston#logging-levels)|

## Job Spec
The service will listen for messages on a pubsub queue, the message should be a valid json data that conforms with the format below.

```json
{
    "JobId": "ff975cbd-32f4-4f09-9b9a-01964dd6eb90",
    "ArweaveTxnId": "ZkUxju5Y5Goy-OXw2O-mj8T_T4JSUHb7sDUhUMLNlgg",
    "Title": "Samuel Dickinson - 2022 World Triathlon Sprint & Relay Championships Montreal",
    "Description": "<TOKEN DESCRIPTION>",
    "Copies": 1,
    "IssuedAt": "1660818999614",
    "ExpiresAt": null,
    "StartsAt": "1660818999614",
    "UpdatedAt": "1660818999614"
}
```

| Field | Type | Description |
| :---- | :--- | :---------- |
| `JobId` | string | **Required**.  A unique string generated by the publisher of the message |
| `ArweaveTxnId` | string | **Required**. Arweave transaction id, the media should be accessible from https://arweave.net/<TX_ID> |
| `Title` | string | **Optional**. NFT title, see [TokenMetadata.title](https://nomicon.io/Standards/Tokens/NonFungibleToken/Metadata#interface) |
| `Description` | string | **Optional**. NFT Description, see [TokenMetadata.description](https://nomicon.io/Standards/Tokens/NonFungibleToken/Metadata#interface) |
| `Copies` | number | **Optional**. NFT copies, see [TokenMetadata.copies](https://nomicon.io/Standards/Tokens/NonFungibleToken/Metadata#interface) |
| `IssuedAt` | string | **Optional**. NFT issuedAt, see [TokenMetadata.issued_at](https://nomicon.io/Standards/Tokens/NonFungibleToken/Metadata#interface) |
| `ExpiresAt` | string | **Optional**. NFT expiresAt, see [TokenMetadata.expires_at](https://nomicon.io/Standards/Tokens/NonFungibleToken/Metadata#interface) |
| `StartsAt` | string | **Optional**. NFT startsAt, see [TokenMetadata.starts_at](https://nomicon.io/Standards/Tokens/NonFungibleToken/Metadata#interface) |
| `UpdatedAt` | string | **Optional**. NFT updatedAt, see [TokenMetadata.updated_at](https://nomicon.io/Standards/Tokens/NonFungibleToken/Metadata#interface) |
## Events

the processor will emit events and send it to the configured `DEFAULT_CALLBACK_URL` if `CallbackURL` is not specified on jobs. 

### Started Event
Emmited to notify the callback url that the processor has received the job and is currently processing it.
```json
{
    "JobId": "ff975cbd-32f4-4f09-9b9a-01964dd6eb90",
    "Event": "started",
    "Time": 1659965535,
    "Message": "Job Started"
}
```
### Failure Event
Emmited to notify the callback url that an error has occured.
```json
{
    "JobId": "ff975cbd-32f4-4f09-9b9a-01964dd6eb90",
    "Event": "failure",
    "Time": 1659965535,
    "Message": "Example Error Message"
}

```
### Success Event
Emmited to notify the callback url that the job has successfully finished.
```json
{
    "JobId": "ff975cbd-32f4-4f09-9b9a-01964dd6eb90",
    "Event": "success",
    "Message": "Job ff975cbd-32f4-4f09-9b9a-01964dd6eb90 has been successfully processed",
    "Details": {
        "Token": {
            "token_id": "88eb3a00-3588-465e-89de-29e094fea7ff",
            "owner_id": "nft.nftdw-001.testnet",
            "metadata": {
                "title": "Samuel Dickinson - 2022 World Triathlon Sprint & Relay Championships Montreal",
                "description": "<TOKEN DESCRIPTION>",
                "media": "ZkUxju5Y5Goy-OXw2O-mj8T_T4JSUHb7sDUhUMLNlgg",
                "media_hash": "IC71AwHciMXvW4WV8soqndptMjYE3WYy4/hdlRhUAqY=",
                "copies": 1,
                "issued_at": "1660818999614",
                "expires_at": null,
                "starts_at": "1660818999614",
                "updated_at": "1660818999614",
                "extra": "{\"AthleteId\":\"88205\",\"FirstName\":\"Samuel\",\"LastName\":\"Dickinson\",\"Country\":\"ENG\",\"Status\":\"\",\"StartNumber\":\"10\",\"Position\":19,\"TotalTime\":\"00:53:40\",\"Timings\":[{\"Key\":\"Swim\",\"Value\":\"00:08:46\"},{\"Key\":\"T1\",\"Value\":\"00:00:59\"},{\"Key\":\"Bike\",\"Value\":\"00:26:04\"},{\"Key\":\"T2\",\"Value\":\"00:00:19\"},{\"Key\":\"Run\",\"Value\":\"00:17:32\"}]}",
                "reference": "ZkUxju5Y5Goy-OXw2O-mj8T_T4JSUHb7sDUhUMLNlgg/metadata.json",
                "reference_hash": "PmkI+VJyQwHn9kXhoYy4MXlREkNmKba6txrUek5kBg0="
            },
            "approved_account_ids": {}
        },
        "ExplorerURL": "https://explorer.testnet.near.org/transactions/E9237ZHVQ8ANEtRfzEAkuVkSjxyCZYc9cxeTCfsREoQ9",
        "TransactionId": "E9237ZHVQ8ANEtRfzEAkuVkSjxyCZYc9cxeTCfsREoQ9"
    },
    "Time": 1661128110153
}
```

## Process Flow